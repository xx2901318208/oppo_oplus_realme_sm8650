name: Build SukiSu Ultra For Realme GT5 Pro
on:
  workflow_dispatch:
    inputs:
      CPU:
        description: "å¤„ç†å™¨åˆ†æ”¯"
        required: true
        default: 'sm8650'
      MANIFEST:
        description: "é…ç½®æ–‡ä»¶"
        required: true
        default: 'gt5pro'
      CPUD:
        description: "å¤„ç†å™¨ä»£å·"
        required: true
        default: 'pineapple'
      ANDROID_VERSION:
        description: "å†…æ ¸å®‰å“ç‰ˆæœ¬"
        required: true
        default: 'android14'
      KERNEL_VERSION:
        description: "å†…æ ¸ç‰ˆæœ¬"
        required: true
        default: '6.1'
      SUSFS_ENABLED:
        description: "æ·»åŠ  SUSFS"
        required: true
        type: boolean
        default: true
      BUILD_METHOD:
        type: choice
        description: "ç¼–è¯‘æ–¹å¼"
        required: true
        default: gki
        options:
          - gki
      lz4k_enable:
        description: 'æ˜¯å¦å®‰è£… LZ4K è¡¥ä¸'
        required: true
        type: boolean
        default: true
      kpm_enable:
        description: 'æ˜¯å¦æ·»åŠ  KPM (å†…æ ¸æ¨¡å—) æ”¯æŒ'
        required: true
        type: boolean
        default: true
      kernel_suffix:
        description: 'å†…æ ¸åç¼€(ç•™ç©ºé»˜è®¤,å¼€å¤´åˆ«åŠ è¿å­—ç¬¦)'
        required: true
        type: string
        default: 'android14-11-o-gc88ee742fca6'

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      ksuver: ${{ steps.ksu_version.outputs.ksuver }}

    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Checkout
        uses: actions/checkout@main

      - name: Config and dependencies
        run: |
          echo "DATE=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV
          git config --global user.name "github-act          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          sudo apt-get update -qq
          sudo apt-get install -qq -y python3 git curl bison flex make binutils dwarves lld pahole zip perl gcc python-is-python3 bc libssl-dev libelf-dev
          curl -sSL "https://storage.googleapis.com/git-repo-downloads/repo" -o ~/repo
          chmod +x ~/repo
          sudo mv ~/repo /usr/local/bi     
      - name: Initialize repo and sync
        run: |
          rm -rf kernel_workspace && mkdir kernel_workspace && cd kernel_workspace
          echo "æ­£åœ¨å…‹éš†æºç ä»“åº“..."
          git clone --branch scx https://github.com/ferstar/realme_GT5pro-AndroidV-vendor-source.git vendor
          mv vendor/* ..
          git clone --depth 1 --branch scx https://github.com/ferstar/realme_GT5pro-AndroidV-common-source.git common
          echo "æ­£åœ¨å»é™¤ ABI ä¿æŠ¤ & å»é™¤ dirty åç¼€..."
          rm common/android/abi_gki_protected_exports_* || true
          rm msm-kernel/android/abi_gki_protected_exports_* || true
          for f in common/scripts/setlocalversion; do
            sed -i 's/ -dirty//g' "$f"
            sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' "$f"
          do      
      - name: Set up KernelSU-SukiSU Ultra
        run: |
          cd kernel_workspace
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s susfs-dev
          cd ./KernelSU
          KSU_VERSION=$(expr $(/usr/bin/git rev-list --count main) "+" 10606)
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
          sed -i "s/DKSU_VERSION=12800/DKSU_VERSION=${KSU_VERSION}/" kernel/Makefile

      - name: Set up susfs
        if: github.event.inputs.SUSFS_ENABLED == 'true'
        run: |
          cd kernel_workspace
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}
          git clone https://github.com/SukiSU-Ultra/SukiSU_patch.git
          echo "Patching susfs"
          cp ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch ./common/
          cp ../susfs4ksu/kernel_patches/fs/* ./common/fs/
          cp ../susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/

          echo "patching zram"
          cp -r ../SukiSU_patch/other/zram/lz4k/include/linux/* ./common/include/linux
          cp -r ../SukiSU_patch/other/zram/lz4k/lib/* ./common/lib
          cp -r ../SukiSU_patch/other/zram/lz4k/crypto/* ./common/crypto
          cp -r ../SukiSU_patch/other/zram/lz4k_oplus ./common/lib/
          
          # Apply patches
          cd ./common
          patch -p1 -F 3 < 50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch || true
          cp ../../SukiSU_patch/hooks/syscall_hooks.patch ./
          cp ../../SukiSU_patch/69_hide_stuff.patch ./
          echo "Patching hide_stuff"
          patch -p1 -F 3 < 69_hide_stuff.patch
          echo "Patching vfs"
          patch -p1 -F 3 < syscall_hooks.patch
          patch -p1 < ../../.repo/manifests/patches/0001-lz4-v1.10.0.patch
          patch -p1 < ../../.repo/manifests/patches/0001-zstd-v1.5.7.patch

          cp ../../SukiSU_patch/other/zram/zram_patch/${{ github.event.inputs.KERNEL_VERSION }}/lz4kd.patch ./
          echo "Patching lz4kd"
          patch -p1 -F 3 < lz4kd.patch || true
          echo 'Patching lz4kd_patch finish'
          cp ../../SukiSU_patch/other/zram/zram_patch/${{ github.event.inputs.KERNEL_VERSION }}/lz4k_oplus.patch ./
          echo "patching lz4k_oplus"
          patch -p1 -F 3 < lz4k_oplus.patch || true
          echo 'patching lz4k_oplus_patch finish'

      - name: Apply new hook and add configuration
        run: |
          cd kernel_workspace/kernel_platform
          DEFCONFIG_FILE="./common/arch/arm64/configs/gki_defconfig"

          # Helper function to set config, ensuring no duplicates and correct value
          set_config() {
            local config_name=$1
            local config_value=$2
            # Delete existing line for the config
            sed -i "/^${config_name}=/d" "$DEFCONFIG_FILE"
            # Add the new config line
            echo "${config_name}=${config_value}" >> "$DEFCONFIG_FILE"
          }

          set_config "CONFIG_KSU" "y"
          set_config "CONFIG_KSU_SUSFS_SUS_SU" "n"
          set_config "CONFIG_KSU_MANUAL_HOOK" "y"
          set_config "CONFIG_KSU_SUSFS" "y"
          set_config "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT" "y"
          set_config "CONFIG_KSU_SUSFS_SUS_PATH" "y"
          set_config "CONFIG_KSU_SUSFS_SUS_MOUNT" "y"
          set_config "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT" "y"
          set_config "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT" "y"
          set_config "CONFIG_KSU_SUSFS_SUS_KSTAT" "y"
          set_config "CONFIG_KSU_SUSFS_SUS_OVERLAYFS" "n"
          set_config "CONFIG_KSU_SUSFS_TRY_UMOUNT" "y"
          set_config "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT" "y"
          set_config "CONFIG_KSU_SUSFS_SPOOF_UNAME" "y"
          set_config "CONFIG_KSU_SUSFS_ENABLE_LOG" "y"
          set_config "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS" "y"
          set_config "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG" "y"
          set_config "CONFIG_KSU_SUSFS_OPEN_REDIRECT" "y"
          set_config "CONFIG_NET_SCH" "y"
          set_config "CONFIG_DEFAULT_FQ" "y"
          set_config "CONFIG_DEFAULT_NET_SCH" "fq"
          
          # æ ¹æ®è¾“å…¥é€‰é¡¹è®¾ç½® KPM æ”¯æŒ
          if [[ "${{ github.event.inputs.kpm_enable }}" == "true" ]]; then
            set_config "CONFIG_KPM" "y"
          else
            set_config "CONFIG_KPM" "n"
          fi

          # Add tethering config settings (moved out of lz4k_enable block and using set_config)
          set_config "CONFIG_IP_NF_TARGET_TTL" "y"
          set_config "CONFIG_IP6_NF_TARGET_HL" "y"
          set_config "CONFIG_IP6_NF_MATCH_HL" "y"
          
          # Add personal config setting (moved out of lz4k_enable block and using set_config)
          set_config "CONFIG_IP_NF_TARGET_ECN" "y"

          if [[ "${{ github.event.inputs.lz4k_enable }}" == "true" ]]; then
            set_config "CONFIG_ZSMALLOC" "y"
            set_config "CONFIG_CRYPTO_LZ4HC" "y"
            set_config "CONFIG_CRYPTO_LZ4K" "y"
            set_config "CONFIG_CRYPTO_LZ4KD" "y"
            set_config "CONFIG_CRYPTO_842" "y"
            
            # Add tmpfs config setting
            set_config "CONFIG_TMPFS_XATTR" "y"
            set_config "CONFIG_TMPFS_POSIX_ACL" "y"
           
            # Add bbr and fq config setting
            set_config "CONFIG_TCP_CONG_ADVANCED" "y"
            set_config "CONFIG_TCP_CONG_BBR" "y"
            set_config "CONFIG_TCP_CONG_BIC" "y"
            set_config "CONFIG_TCP_CONG_WESTWOOD" "y"
            set_config "CONFIG_TCP_CONG_HTCP" "y"
            
            # Add rcu config setting
            set_config "CONFIG_RCU_TRACE" "n"
          fi
          sed -i 's/check_defconfig//' ./common/build.config.gki

      - name: Force ECN + Reduce overhead
        if: ${{ github.event.inputs.KERNEL_VERSION == '6.1' || github.event.inputs.KERNEL_VERSION == '6.6' }}
        run: |
          cd kernel_workspace/kernel_platform/common/net/ipv4
          sed -i 's/net->ipv4.sysctl_tcp_ecn = 2;/net->ipv4.sysctl_tcp_ecn = 1;/' tcp_ipv4.c
          grep "sysctl_tcp_ecn" tcp_ipv4.c
          sed -i '/\.procname[[:space:]]*=[[:space:]]*"tcp_ecn"/, /^[[:space:]]*\}/ s/SYSCTL_TWO/SYSCTL_ONE/' sysctl_net_ipv4.c
          grep -A6 '\.procname.*tcp_ecn' sysctl_net_ipv4.c
          sed -i 's/net->ipv4.sysctl_tcp_pacing_ss_ratio = 200;/net->ipv4.sysctl_tcp_pacing_ss_ratio = 150;/' tcp_ipv4.c
          sed -i 's/net->ipv4.sysctl_tcp_pacing_ca_ratio = 120;/net->ipv4.sysctl_tcp_pacing_ca_ratio = 110;/' tcp_ipv4.c
          grep "sysctl_tcp_pacing" tcp_ipv4.c
          ls -t | grep -E 'tcp_|sysctl_'
          
          #ç¦ç”¨ defconfig æ£€æŸ¥
          sed -i 's/check_defconfig//' ./common/build.config.gki

      - name: Build kernel
        run: |
          cd kernel_workspace/common
          ./build_with_bazel.py -t ${{ github.event.inputs.CPUD }} ${{ github.event.inputs.BUILD_METHOD }}
          
      - name: Apply KPM configs
        # ä»…åœ¨å¯ç”¨ KPM æ—¶æ‰§è¡Œæ­¤æ­¥éª¤
        if: ${{ github.event.inputs.kpm_enable == 'true' }}
        run: |
          cd kernel_workspace/common/out/arch/arm64/boot
          curl -LO https://github.com/ShirkNeko/SukiSU_KernelPatch_patch/releases/download/0.11-beta/patch_linux
          chmod +x patch_linux
          ./patch_linux
          rm -f Image
          mv oImage Image

      - name: Apply patch_linux and replace Image
        run: |
          cd kernel_workspace/kernel_platform/out/msm-kernel-${{ github.event.inputs.CPUD }}-${{ github.event.inputs.BUILD_METHOD }}/dist
          curl -LO https://github.com/SukiSU-Ultra/SukiSU_KernelPatch_patch/releases/download/0.11-beta/patch_linux
          chmod +x patch_linux
          ./patch_linux
          rm -f Image
          mv oImage Image

      - name: Make AnyKernel3
        run: |
          git clone https://github.com/Kernel-SU/AnyKernel3.git --depth=1
          rm -rf ./AnyKernel3/.git
          cd AnyKernel3
          cp ../kernel_workspace/kernel_platform/out/msm-kernel-${{ github.event.inputs.CPUD }}-${{ github.event.inputs.BUILD_METHOD }}/dist/Image ./Image
          if [ ! -f ./Image ]; then
            echo "Kernel image file not found, build may fail"
            exit 1
          fi
          if [[ ${{ github.event.inputs.lz4k_enable }} == "true" ]]; then
            wget https://raw.githubusercontent.com/Suxiaoqinx/kernel_manifest_OnePlus_Sukisu_Ultra/main/zram.zip
          fi
          if [[ -n "${{ github.event.inputs.kernel_suffix }}" ]]; then
            zip -r ../AnyKernel3_SukiSU_${{ env.KSUVER }}_${{ env.KERNEL_VERSION }}_A15_${{ github.event.inputs.kernel_suffix }}.zip ./*
          else
            zip -r ../AnyKernel3_SukiSU_${{ env.KSUVER }}_${{ env.KERNEL_VERSION }}_A15_${{ env.KERNEL_NAME }}.zip ./*
          fi

      - name: ä¸Šä¼  ZIP å·¥ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: AnyKernel3_SukiSUUltra_${{ env.KSUVER }}_${{ github.event.inputs.MANIFEST }}_${{ github.event.inputs.kernel_suffix }}
          path: ${{ github.workspace }}/kernel_workspace/*.zip


  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: read
      
    steps:
      - name: ä¸‹è½½ ZIP å·¥ä»¶
        uses: actions/download-artifact@v4
        with:
          name: AnyKernel3_SukiSUUltra_${{ needs.build.outputs.ksuver }}_${{ github.event.inputs.MANIFEST }}_${{ github.event.inputs.kernel_suffix }}
          path: ./release_zips

      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          if [[ -n "${{ github.event.inputs.kernel_suffix }}" ]]; then
            FULL_VERSION=${{ format("{0}.75-{1}", env.KERNEL_VERSION, github.event.inputs.kernel_suffix) }}
            echo "FULL_VERSION=$FULL_VERSION" >> $GITHUB_ENV
            export FULL_VERSION=$FULL_VERSION
          else
            FULL_VERSION=${{ format("{0}.75-{1}", env.KERNEL_VERSION, env.KERNEL_NAME) }}
            echo "FULL_VERSION=$FULL_VERSION" >> $GITHUB_ENV
            export FULL_VERSION=$FULL_VERSION
          fi
          TIME="$(TZ=\'Asia/Shanghai\' date +\'%y%m%d%H%M%S\')"
          TIME_FORM="$(TZ=\'Asia/Shanghai\' date +\'%Y-%m-%d %H:%M:%S\')"
          echo "TIME=$TIME" >> $GITHUB_ENV
          echo "TIME_FORM=$TIME_FORM" >> $GITHUB_ENV
          TAG_HEAD="OPPO+OPlus+Realme-A15-build"
          echo "TAG_HEAD=$TAG_HEAD" >> $GITHUB_ENV
         
      - name: åˆ›å»ºå‘å¸ƒ
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "${{ env.TAG_HEAD }}-${{ env.TIME }}"
          name: "${{ env.TAG_HEAD }}-${{ env.FULL_VERSION }}"
          body: |
            ### ğŸ“± æ¬§åŠ çœŸ Android 15 SukiSU-Ultra SM8650 é€šç”¨å†…æ ¸ | æ„å»ºä¿¡æ¯
            - å†…æ ¸ç‰ˆæœ¬å·: ${{ env.FULL_VERSION }}
            - ç¼–è¯‘æ—¶é—´: ${{ env.TIME_FORM }}
            - æœºå‹ï¼šæ¬§åŠ çœŸéªé¾™8Gen3 6.1 Android 15å†…æ ¸é€šç”¨ï¼ˆåŸºäº Android 15 ç‰ˆå®˜æ–¹OKIæºç ï¼‰
            - ç‰¹æ€§ï¼šSukiSU Ultra + SUSFS + VFS
            - LZ4Kæ”¯æŒï¼š${{ github.event.inputs.lz4k_enable }}
            - KPMæ”¯æŒï¼š${{ github.event.inputs.kpm_enable }}
            - æ¨èç³»ç»Ÿï¼šColorOS 15 / RealmeUI 6.0
            - SukiSUç®¡ç†å™¨ä¸‹è½½ï¼š[SukiSU-Ultra](https://github.com/ShirkNeko/SukiSU-Ultra/releases)
            ### â«ï¸ æ›´æ–°å†…å®¹ï¼š
            - æ›´æ–°SukiSU Ultraè‡³æœ€æ–°ç‰ˆæœ¬ï¼ˆ${{ needs.build.outputs.ksuver }}ï¼‰
            - (é¢„ç•™)
            ### ğŸ“‹ å®‰è£…æ–¹æ³• | Installation Guide
            1. è‹¥ä½ çš„æ‰‹æœºå·²ç»å®‰è£…äº†ç¬¬ä¸‰æ–¹Recoveryï¼ˆå¦‚TWRP)ï¼Œå¯ä¸‹è½½å¯¹åº”æœºå‹çš„AnyKernelåˆ·æœºåŒ…åè¿›å…¥Recoveryæ¨¡å¼ï¼Œé€šè¿‡Recoveryåˆ·å…¥åˆ·æœºåŒ…åé‡å¯è®¾å¤‡
            2. è‹¥ä½ çš„æ‰‹æœºä¹‹å‰å·²æœ‰ root æƒé™ï¼Œå¯åœ¨æ‰‹æœºä¸Šå®‰è£…[HorizonKernelFlasher](https://github.com/libxzr/HorizonKernelFlasher/releases)ï¼Œåœ¨HorizonKernelFlasherä¸­åˆ·å…¥AnyKernelåˆ·æœºåŒ…å¹¶é‡å¯
            3. è‹¥ä½ ä¹‹å‰å·²åˆ·å…¥SukiSU Ultraå†…æ ¸ï¼Œä¸”SukiSU Ultraç®¡ç†å™¨å·²æ›´æ–°è‡³æœ€æ–°ç‰ˆæœ¬ï¼Œå¯åœ¨SukiSU Ultraç®¡ç†å™¨ä¸­ç›´æ¥åˆ·å…¥AnyKernelåˆ·æœºåŒ…å¹¶é‡å¯
            â€»â€»â€»åˆ·å†™å†…æ ¸æœ‰é£é™©ï¼Œä¸ºé˜²æ­¢å‡ºç°æ„å¤–å¯¼è‡´æ‰‹æœºå˜ç –ï¼Œåœ¨åˆ·å…¥å†…æ ¸å‰è¯·åŠ¡å¿…ç”¨[KernelFlasher](https://github.com/capntrips/KernelFlasher)ç­‰è½¯ä»¶å¤‡ä»½bootç­‰å…³é”®å¯åŠ¨åˆ†åŒº!â€»â€»â€»
          draft: false
          prerelease: false
          files: |
            release_zips/AnyKernel3_*.zip
