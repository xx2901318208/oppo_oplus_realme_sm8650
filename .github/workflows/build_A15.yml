name: æ¬§åŠ çœŸ Android 15 é€šç”¨OKIå†…æ ¸

env:
  TZ: Asia/Shanghai
  CPU: 'sm8650'
  FEIL: 'oppo+oplus+realme'
  ANDROID_VERSION: 'android14'
  KERNEL_VERSION: '6.1'
  KERNEL_NAME: '6.1.75-android14-11-o-ge2f97ae7184b'
  KERNELSU_VARIANT: 'SukiSU-Ultra'
  KERNELSU_BRANCH: 'susfs-main'

on:
  workflow_dispatch:
  # å–æ¶ˆæ­¤å¤„æ³¨é‡Šä»£ç å¯å¼€å¯æ¯æ—¥å®šæ—¶ç¼–è¯‘
#  schedule:
#    - cron: '0 23 * * *'  # UTCæ—¶é—´23ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´æ¬¡æ—¥7ç‚¹ï¼‰
    inputs:
      hook_method:
        description: hookæ¨¡å¼(å¤§éƒ¨åˆ†æƒ…å†µmanualå³å¯ï¼Œå°‘æ•°éœ€åˆ‡æ¢sus suæ¨¡å¼çš„åœºæ™¯æ‰éœ€è¦kprobesé’©å­)
        required: true
        type: choice
        default: 'manual'
        options:
          - 'manual'
          - 'kprobes'
      lz4k_enable:
        description: 'æ˜¯å¦å®‰è£… LZ4K è¡¥ä¸'
        required: true
        type: choice
        default: 'true'
        options:
          - 'true'
          - 'false'
      lz4_enable:
        description: 'æ˜¯å¦å®‰è£… lz4 + zstd è¡¥ä¸'
        required: true
        type: choice
        default: 'true'
        options:
          - 'true'
          - 'false'
      bbr_enable:
        description: "æ˜¯å¦å¯ç”¨bbrç®—æ³•(ä¼˜åŒ–ä¸Šè¡Œæ•°æ®,å¯¹æ‰‹æœºæ—¥ç”¨æ— å¤ªå¤§æ„ä¹‰ç”šè‡³å¯èƒ½è´Ÿä¼˜åŒ–;falseå…³é—­,trueä»…åŠ å…¥ç®—æ³•,defaultè®¾ä¸ºé»˜è®¤)"
        required: true
        type: choice
        default: 'true'
        options:
          - 'false'
          - 'true'
          - 'default'
      ssg_enable:
        description: 'æ˜¯å¦å¯ç”¨ä¸‰æ˜ŸSSG IOè°ƒåº¦å™¨'
        required: true
        type: choice
        default: 'true'
        options:
          - 'true'
          - 'false'
      scx_enable:
        description: 'æ˜¯å¦å®‰è£…é£é©°å†…æ ¸é©±åŠ¨(æœªå®Œæˆ)'
        required: true
        type: choice
        default: 'false'
        options:
          - 'true'
          - 'false'
      kernel_suffix:
        description: 'å†…æ ¸åç¼€(ç•™ç©ºé»˜è®¤,å¼€å¤´åˆ«åŠ è¿å­—ç¬¦)'
        required: false
        type: string
        default: '6.1.75-android14-11-o-ge2f97ae7184b'

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      ksuver: ${{ steps.ksu_version.outputs.ksuver }}
    steps:
      - name: æœ€å¤§åŒ–å»ºç­‘ç©ºé—´
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          swap-size-mb: 8192
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: å®‰è£…é…ç½®ç¯å¢ƒä¾èµ–
        run: |
          sudo apt update && sudo apt upgrade -y
          sudo apt-get install curl bison flex make binutils dwarves git lld pahole zip perl make gcc python3 python-is-python3 bc libssl-dev libelf-dev -y
          sudo rm -rf ./llvm.sh
          sudo wget https://apt.llvm.org/llvm.sh
          sudo chmod +x llvm.sh
          sudo ./llvm.sh 20 all

      - name: åˆå§‹åŒ–æºç ä»“åº“
        id: init_repo
        run: |
          echo "æ­£åœ¨åˆå§‹åŒ–å·¥ä½œç©ºé—´..."
          rm -rf kernel_workspace
          mkdir -p kernel_workspace
          
          echo "æ­£åœ¨å…‹éš†æºç ä»“åº“..."
          git clone --branch master https://github.com/ferstar/realme_GT5pro-AndroidV-vendor-source.git vendor
          mv vendor/* kernel_workspace/ || true
          
          cd kernel_workspace
          git clone --depth 1 --branch master https://github.com/ferstar/realme_GT5pro-AndroidV-common-source.git common
          
          echo "æ­£åœ¨å»é™¤ ABI ä¿æŠ¤ & å»é™¤ dirty åç¼€..."
          rm common/android/abi_gki_protected_exports_* 2>/dev/null || true
          for f in common/scripts/setlocalversion; do
            sed -i 's/ -dirty//g' "$f"
            sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' "$f"
          done
          
          echo "å·¥ä½œç©ºé—´å†…å®¹:"
          ls -la

      - name: æ·»åŠ  SukiSU-Ultra
        id: ksu_version
        run: |
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          cd kernel_workspace
          echo "æ·»åŠ  SukiSU å‰çš„ç›®å½•å†…å®¹:"
          ls -la
          
          curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU-Ultra/refs/heads/main/kernel/setup.sh" | bash -s susfs-main
          
          cd KernelSU
          KSU_VERSION=$(expr $(git rev-list --count HEAD) "+" 10700)
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
          echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT
          export KSU_VERSION=$KSU_VERSION
          sed -i "s/DKSU_VERSION=12800/DKSU_VERSION=$KSU_VERSION/" kernel/Makefile
          
          echo "æ·»åŠ  SukiSU åçš„ç›®å½•å†…å®¹:"
          cd ..
          ls -la

      - name: åº”ç”¨ SUSFS ä¿®è¡¥ç¨‹åº SukiSU-Ultra
        run: |
          cd kernel_workspace
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          
          git clone https://github.com/ShirkNeko/susfs4ksu.git -b gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}
          git clone https://github.com/ShirkNeko/SukiSU_patch.git
          git clone https://github.com/Xiaomichael/kernel_patches.git
          
          cp ./susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch ./common/
          cp ./susfs4ksu/kernel_patches/fs/* ./common/fs/
          cp ./susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/
          cp ./SukiSU_patch/hooks/syscall_hooks.patch ./common/
          
          cd common
          patch -p1 < 50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch || true
          patch -p1 < syscall_hooks.patch || true
          
          echo "åº”ç”¨è¡¥ä¸åçš„ common ç›®å½•:"
          ls -la

      - name: åº”ç”¨lz4 1.10.0 & zstd 1.5.7è¡¥ä¸
        if: ${{ github.event.inputs.lz4_enable == 'true' }}
        run: |
          echo "æ­£åœ¨æ·»åŠ lz4 1.10.0 & zstd 1.5.7è¡¥ä¸â€¦"
          cd kernel_workspace
          git clone https://github.com/cctv18/oppo_oplus_realme_sm8650.git
          cp ./oppo_oplus_realme_sm8650/zram_patch/001-lz4.patch ./common/
          cp ./oppo_oplus_realme_sm8650/zram_patch/lz4armv8.S ./common/lib
          cp ./oppo_oplus_realme_sm8650/zram_patch/002-zstd.patch ./common/
          
          cd common
          git apply -p1 < 001-lz4.patch || true
          patch -p1 < 002-zstd.patch || true

      - name: åº”ç”¨ Hide Stuff è¡¥ä¸
        run: |
          cd kernel_workspace/common
          cp ../SukiSU_patch/69_hide_stuff.patch ./
          patch -p1 < 69_hide_stuff.patch

      - name: åº”ç”¨ lz4kd è¡¥ä¸
        if: ${{ github.event.inputs.lz4k_enable == 'true' }}
        run: |
          echo "æ­£åœ¨æ·»åŠ lz4kdè¡¥ä¸â€¦"
          cd kernel_workspace/common
          cp -r ../SukiSU_patch/other/zram/lz4k/include/linux/* ./include/linux/
          cp -r ../SukiSU_patch/other/zram/lz4k/lib/* ./lib
          cp -r ../SukiSU_patch/other/zram/lz4k/crypto/* ./crypto
          cp ../SukiSU_patch/other/zram/zram_patch/${{ env.KERNEL_VERSION }}/lz4kd.patch ./
          patch -p1 -F 3 < lz4kd.patch || true

      - name: æ·»åŠ  SUSFS é…ç½®è®¾ç½®
        run: |
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          cd kernel_workspace/common
          
          echo "æ­£åœ¨é…ç½®å†…æ ¸é€‰é¡¹..."
          {
            echo "CONFIG_KSU=y"
            echo "CONFIG_KPM=y"
            
            if [ "${{ github.event.inputs.hook_method }}" == "kprobes" ]; then
              echo "æ­£åœ¨å¼€å¯kprobesé’©å­..."
              echo "CONFIG_KSU_SUSFS_SUS_SU=y"
              echo "CONFIG_KSU_MANUAL_HOOK=n"
              echo "CONFIG_KSU_KPROBES_HOOK=y"
            else
              echo "æ­£åœ¨å¼€å¯manualé’©å­..."
              echo "CONFIG_KSU_MANUAL_HOOK=y"
              echo "CONFIG_KSU_SUSFS_SUS_SU=n"
            fi
            
            echo "CONFIG_KSU_SUSFS=y"
            echo "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y"
            echo "CONFIG_KSU_SUSFS_SUS_PATH=y"
            echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y"
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y"
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y"
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSTAT_SUPPORT=y"
            echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y"
            echo "CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n"
            echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y"
            echo "CONFIG_KSU_SUSFS_TRY_UMOUNT_SUPPORT=y"
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y"
            echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y"
            echo "CONFIG_KSU_SUSFS_ENABLE_LOG=n"
            echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y"
            echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y"
            echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y"
            
            # é€šç”¨é…ç½®
            echo "CONFIG_IP_NF_TARGET_TTL=y"
            echo "CONFIG_IP6_NF_TARGET_HL=y"
            echo "CONFIG_IP6_NF_MATCH_HL=y"
            echo "CONFIG_TMPFS_XATTR=y"
            echo "CONFIG_TMPFS_POSIX_ACL=y"
            echo "CONFIG_RCU_TRACE=n"
            echo "CONFIG_IP_NF_TARGET_ECN=y"
            
            # LZ4K é…ç½®
            if [ "${{ github.event.inputs.lz4k_enable }}" == "true" ]; then
              echo "CONFIG_ZSMALLOC=y"
              echo "CONFIG_CRYPTO_LZ4HC=y"
              echo "CONFIG_CRYPTO_LZ4K=y"
              echo "CONFIG_CRYPTO_LZ4KD=y"
              echo "CONFIG_CRYPTO_842=y"
              echo "CONFIG_ZRAM_WRITEBACK=y"
            fi
            
            # BBR é…ç½®
            if [[ "${{ github.event.inputs.bbr_enable }}" == "true" || "${{ github.event.inputs.bbr_enable }}" == "default" ]]; then
              echo "CONFIG_TCP_CONG_ADVANCED=y"
              echo "CONFIG_TCP_CONG_BBR=y"
              echo "CONFIG_TCP_CONG_CUBIC=y"
              echo "CONFIG_TCP_CONG_VEGAS=y"
              echo "CONFIG_TCP_CONG_NV=y"
              echo "CONFIG_TCP_CONG_BRUTAL=y"
              echo "CONFIG_NET_SCH_FQ=y"
              echo "CONFIG_TCP_CONG_BIC=n"
              echo "CONFIG_TCP_CONG_WESTWOOD=y"
              echo "CONFIG_TCP_CONG_HTCP=y"
              echo "CONFIG_DEFAULT_BBR=y"
              echo "CONFIG_NET_SCH_DEFAULT=y"
              echo "CONFIG_DEFAULT_FQ=y"
              echo "CONFIG_DEFAULT_NET_SCH=fq"
              
              if [ "${{ github.event.inputs.bbr_enable }}" == "default" ]; then
                echo "CONFIG_DEFAULT_TCP_CONG=bbr"
              else
                echo "CONFIG_DEFAULT_TCP_CONG=cubic"
              fi
            fi
          } >> arch/arm64/configs/gki_defconfig
          
          echo "é…ç½®å®Œæˆåçš„ gki_defconfig å°¾éƒ¨:"
          tail -n 20 arch/arm64/configs/gki_defconfig

      
          # ç¦ç”¨ defconfig æ£€æŸ¥
          cd ../../../
          sed -i 's/check_defconfig//' build.config.gki

      - name: å¯ç”¨ä¸‰æ˜ŸSSG IOè°ƒåº¦å™¨
        if: ${{ github.event.inputs.ssg_enable == 'true' }}
        run: |
          cd kernel_workspace/common
          echo "CONFIG_MQ_IOSCHED_SSG=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_MQ_IOSCHED_SSG_CGROUP=y" >> arch/arm64/configs/gki_defconfig

      - name: æ·»åŠ åˆ¶ä½œåç§°
        run: |
          cd kernel_workspace/common
          echo "æ›¿æ¢å†…æ ¸ç‰ˆæœ¬åç¼€..."
          if [[ -n "${{ github.event.inputs.kernel_suffix }}" ]]; then
            echo "ä½¿ç”¨è‡ªå®šä¹‰åç¼€: ${{ github.event.inputs.kernel_suffix }}"
            sed -i "\$s|echo \"\\\$res\"|echo \"-${{ github.event.inputs.kernel_suffix }}\"|" scripts/setlocalversion
          else
            echo "ä½¿ç”¨é»˜è®¤åç¼€: ${{ env.KERNEL_NAME }}"
            sed -i "\$s|echo \"\\\$res\"|echo \"-${{ env.KERNEL_NAME }}\"|" scripts/setlocalversion
          fi

      - name: æ„å»ºå†…æ ¸
        run: |
          cd kernel_workspace
          if [[ "${{ github.event.inputs.scx_enable }}" == "true" ]]; then
            echo "æ·»åŠ é£é©°å†…æ ¸é©±åŠ¨..."
            git clone https://github.com/cctv18/sched_ext.git
            rm -rf ./sched_ext/.git
            rm -rf ./sched_ext/README.md
            cp -r ./sched_ext/* ./common/kernel/sched
          fi
          
          cd common
          echo "å¼€å§‹å†…æ ¸ç¼–è¯‘..."
          make -j$(nproc --all) LLVM=-20 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- \
            CROSS_COMPILE_ARM32=arm-linux-gnuabeihf- CC=clang LD=ld.lld \
            HOSTCC=clang HOSTLD=ld.lld O=out KCFLAGS+=-Wno-error gki_defconfig all
          echo "å†…æ ¸ç¼–è¯‘å®Œæˆï¼"
          ls -la out/arch/arm64/boot

      - name: Apply patch_linux and replace Image
        run: |
          cd kernel_workspace/common/out/arch/arm64/boot
          curl -LO https://github.com/ShirkNeko/SukiSU_KernelPatch_patch/releases/download/0.12.0/patch_linux
          chmod +x patch_linux
          ./patch_linux
          rm -f Image
          mv oImage Image
          echo "Image å¤„ç†å®Œæˆ:"
          ls -la

      - name: å…‹éš† AnyKernel3 å¹¶æ‰“åŒ…
        run: |
          cd kernel_workspace
          git clone --depth=1 https://github.com/Kernel-SU/AnyKernel3
          rm -rf ./AnyKernel3/.git
          cd AnyKernel3
          cp ../common/out/arch/arm64/boot/Image ./Image
          
          if [ ! -f ./Image ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°å†…æ ¸é•œåƒæ–‡ä»¶ï¼"
            exit 1
          fi
          
          if [[ -n "${{ github.event.inputs.kernel_suffix }}" ]]; then
            ZIP_NAME="AnyKernel3_SukiSU_${{ env.KSUVER }}_${{ env.KERNEL_VERSION }}_A15_${{ github.event.inputs.kernel_suffix }}.zip"
          else
            ZIP_NAME="AnyKernel3_SukiSU_${{ env.KSUVER }}_${{ env.KERNEL_VERSION }}_A15_${{ env.KERNEL_NAME }}.zip"
          fi
          
          zip -r ../$ZIP_NAME ./*
          echo "æ‰“åŒ…å®Œæˆ: $ZIP_NAME"
          ls -la ../*.zip

      - name: ä¸Šä¼  ZIP å·¥ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: Kernel_ZIP_Artifacts
          path: ${{ github.workspace }}/kernel_workspace/*.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: read
      
    steps:
      - name: ä¸‹è½½ ZIP å·¥ä»¶
        uses: actions/download-artifact@v4
        with:
          name: Kernel_ZIP_Artifacts
          path: ./release_zips

      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          if [[ -n "${{ github.event.inputs.kernel_suffix }}" ]]; then
            FULL_VERSION="${{ env.KERNEL_VERSION }}.${{ env.KSUVER }}-${{ github.event.inputs.kernel_suffix }}"
          else
            FULL_VERSION="${{ env.KERNEL_VERSION }}.${{ env.KSUVER }}-${{ env.KERNEL_NAME }}"
          fi
          echo "FULL_VERSION=$FULL_VERSION" >> $GITHUB_ENV
          
          TIME="$(TZ='Asia/Shanghai' date +'%y%m%d%H%M%S')"
          TIME_FORM="$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
          echo "TIME=$TIME" >> $GITHUB_ENV
          echo "TIME_FORM=$TIME_FORM" >> $GITHUB_ENV
          echo "TAG_HEAD=OPPO+OPlus+Realme-A15-build" >> $GITHUB_ENV
         
      - name: åˆ›å»ºå‘å¸ƒ
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "${{ env.TAG_HEAD }}-${{ env.TIME }}"
          name: "${{ env.TAG_HEAD }}-${{ env.FULL_VERSION }}"
          body: |
            ### ğŸ“± æ¬§åŠ çœŸ Android 15 SukiSU-Ultra SM8650 é€šç”¨å†…æ ¸ | æ„å»ºä¿¡æ¯
            - å†…æ ¸ç‰ˆæœ¬å·: ${{ env.FULL_VERSION }}
            - ç¼–è¯‘æ—¶é—´: ${{ env.TIME_FORM }}
            - æœºå‹ï¼šæ¬§åŠ çœŸéªé¾™8Gen3 6.1 Android 15å†…æ ¸é€šç”¨ï¼ˆåŸºäº Android 15 ç‰ˆå®˜æ–¹OKIæºç ï¼‰
            - ç‰¹æ€§ï¼šSukiSU Ultra + SUSFS + VFS
            - LZ4Kæ”¯æŒï¼š${{ github.event.inputs.lz4k_enable }}
            - æ¨èç³»ç»Ÿï¼šColorOS 15 / RealmeUI 6.0
            - SukiSUç®¡ç†å™¨ä¸‹è½½ï¼š[SukiSU-Ultra](https://github.com/ShirkNeko/SukiSU-Ultra/releases)
            ### â«ï¸ æ›´æ–°å†…å®¹ï¼š
            - æ›´æ–°SukiSU Ultraè‡³æœ€æ–°ç‰ˆæœ¬ï¼ˆ${{ needs.build.outputs.ksuver }}ï¼‰
            - (é¢„ç•™)
            ### ğŸ“‹ å®‰è£…æ–¹æ³• | Installation Guide
            1. è‹¥ä½ çš„æ‰‹æœºå·²ç»å®‰è£…äº†ç¬¬ä¸‰æ–¹Recoveryï¼ˆå¦‚TWRP)ï¼Œå¯ä¸‹è½½å¯¹åº”æœºå‹çš„AnyKernelåˆ·æœºåŒ…åè¿›å…¥Recoveryæ¨¡å¼ï¼Œé€šè¿‡Recoveryåˆ·å…¥åˆ·æœºåŒ…åé‡å¯è®¾å¤‡
            2. è‹¥ä½ çš„æ‰‹æœºä¹‹å‰å·²æœ‰ root æƒé™ï¼Œå¯åœ¨æ‰‹æœºä¸Šå®‰è£…[HorizonKernelFlasher](https://github.com/libxzr/HorizonKernelFlasher/releases)ï¼Œåœ¨HorizonKernelFlasherä¸­åˆ·å…¥AnyKernelåˆ·æœºåŒ…å¹¶é‡å¯
            3. è‹¥ä½ ä¹‹å‰å·²åˆ·å…¥SukiSU Ultraå†…æ ¸ï¼Œä¸”SukiSU Ultraç®¡ç†å™¨å·²æ›´æ–°è‡³æœ€æ–°ç‰ˆæœ¬ï¼Œå¯åœ¨SukiSU Ultraç®¡ç†å™¨ä¸­ç›´æ¥åˆ·å…¥AnyKernelåˆ·æœºåŒ…å¹¶é‡å¯
            â€»â€»â€»åˆ·å†™å†…æ ¸æœ‰é£é™©ï¼Œä¸ºé˜²æ­¢å‡ºç°æ„å¤–å¯¼è‡´æ‰‹æœºå˜ç –ï¼Œåœ¨åˆ·å…¥å†…æ ¸å‰è¯·åŠ¡å¿…ç”¨[KernelFlasher](https://github.com/capntrips/KernelFlasher)ç­‰è½¯ä»¶å¤‡ä»½bootç­‰å…³é”®å¯åŠ¨åˆ†åŒº!â€»â€»â€»
          draft: false
          prerelease: false
          files: |
            release_zips/AnyKernel3_*.zip
